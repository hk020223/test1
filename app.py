import streamlit as st
import pandas as pd
import os
import random
from langchain_google_genai import ChatGoogleGenerativeAI
from langchain_core.prompts import PromptTemplate

# -----------------------------------------------------------------------------
# [1] ì„œë²„ ì„¤ì • ë° í™˜ê²½ ë³€ìˆ˜ (Render ì„¤ì •ì—ì„œ GOOGLE_API_KEYë¥¼ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤)
# -----------------------------------------------------------------------------
st.set_page_config(page_title="KW-ê°•ì˜ë§ˆìŠ¤í„°", page_icon="ğŸ“", layout="wide")
api_key = os.environ.get("GOOGLE_API_KEY", "")

# -----------------------------------------------------------------------------
# [2] Pre-loaded Data (í•™êµ ì§€ì‹ ë² ì´ìŠ¤ ë° ê°•ì˜ ì •ë³´)
# -----------------------------------------------------------------------------
# ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” PDFì—ì„œ ì¶”ì¶œí•œ í…ìŠ¤íŠ¸ íŒŒì¼ì´ë‚˜ CSVë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
SCHOOL_RULES = """
[ê´‘ìš´ëŒ€í•™êµ í•™ì‚¬ ê·œì • ìš”ì•½]
- ì¡¸ì—… ì´ìˆ˜ í•™ì : ì´ 130í•™ì  ì´ìƒ (2023í•™ë²ˆ ê¸°ì¤€)
- ì „ê³µ í•„ìˆ˜: í•™ê³¼ë³„ ìƒì´í•˜ë‚˜ ë³´í†µ 21~30í•™ì 
- êµì–‘ í•„ìˆ˜: ì •ë³´ì™€ì‚¬íšŒ, ê´‘ìš´ì¸ì„±, ëŒ€í•™ì˜ì–´ ë“± í¬í•¨ 15í•™ì 
- ì˜ì–´ ì¡¸ì—… ì¸ì¦: í† ìµ 700ì  ì´ìƒ ë˜ëŠ” êµë‚´ ëŒ€ì²´ ê°•ì¢Œ ì´ìˆ˜
- ì¬ìˆ˜ê°•: C+ ì´í•˜ ê³¼ëª©ë§Œ ê°€ëŠ¥, ìµœëŒ€ ì„±ì  A0 ì œí•œ
"""

# ê°€ìƒì˜ ì´ë²ˆ í•™ê¸° ê°œì„¤ ê°•ì¢Œ ë°ì´í„° (ì‹œê°„í‘œ ìƒì„±ìš©)
@st.cache_data
def load_course_db():
    return pd.DataFrame([
        {"ê³¼ëª©ëª…": "ì¸ê³µì§€ëŠ¥ê¸°ì´ˆ", "êµìˆ˜": "ê¹€êµìˆ˜", "ì‹œê°„": "ì›”1,2,3", "ì˜ì—­": "ì „ê³µ", "ê³¼ì œë¹„ì¤‘": 40, "ì‹œí—˜ë¹„ì¤‘": 60, "íŒ€í”Œ": "ìœ "},
        {"ê³¼ëª©ëª…": "ì „ìíšŒë¡œ1", "êµìˆ˜": "ì´êµìˆ˜", "ì‹œê°„": "í™”4,5,6", "ì˜ì—­": "ì „ê³µ", "ê³¼ì œë¹„ì¤‘": 20, "ì‹œí—˜ë¹„ì¤‘": 80, "íŒ€í”Œ": "ë¬´"},
        {"ê³¼ëª©ëª…": "ì•Œê³ ë¦¬ì¦˜", "êµìˆ˜": "ë°•êµìˆ˜", "ì‹œê°„": "ìˆ˜1,2,3", "ì˜ì—­": "ì „ê³µ", "ê³¼ì œë¹„ì¤‘": 50, "ì‹œí—˜ë¹„ì¤‘": 50, "íŒ€í”Œ": "ë¬´"},
        {"ê³¼ëª©ëª…": "ë°ì´í„°ë² ì´ìŠ¤", "êµìˆ˜": "ìµœêµìˆ˜", "ì‹œê°„": "ëª©4,5,6", "ì˜ì—­": "ì „ê³µ", "ê³¼ì œë¹„ì¤‘": 30, "ì‹œí—˜ë¹„ì¤‘": 70, "íŒ€í”Œ": "ìœ "},
        {"ê³¼ëª©ëª…": "ê´‘ìš´ì¸ì„±", "êµìˆ˜": "ì •êµìˆ˜", "ì‹œê°„": "ê¸ˆ1,2", "ì˜ì—­": "êµì–‘", "ê³¼ì œë¹„ì¤‘": 10, "ì‹œí—˜ë¹„ì¤‘": 90, "íŒ€í”Œ": "ë¬´"},
        {"ê³¼ëª©ëª…": "ëŒ€í•™ì˜ì–´", "êµìˆ˜": "Brown", "ì‹œê°„": "ì›”7,8", "ì˜ì—­": "êµì–‘", "ê³¼ì œë¹„ì¤‘": 30, "ì‹œí—˜ë¹„ì¤‘": 70, "íŒ€í”Œ": "ìœ "},
        {"ê³¼ëª©ëª…": "ì°½ì—…ì˜ì´í•´", "êµìˆ˜": "ì†¡êµìˆ˜", "ì‹œê°„": "í™”1,2", "ì˜ì—­": "êµì–‘", "ê³¼ì œë¹„ì¤‘": 50, "ì‹œí—˜ë¹„ì¤‘": 50, "íŒ€í”Œ": "ìœ "},
        {"ê³¼ëª©ëª…": "ì»´í“¨í„°ë„¤íŠ¸ì›Œí¬", "êµìˆ˜": "í•œêµìˆ˜", "ì‹œê°„": "ìˆ˜7,8,9", "ì˜ì—­": "ì „ê³µ", "ê³¼ì œë¹„ì¤‘": 40, "ì‹œí—˜ë¹„ì¤‘": 60, "íŒ€í”Œ": "ë¬´"},
    ])

course_db = load_course_db()

# -----------------------------------------------------------------------------
# [3] AI ì—”ì§„ ì„¤ì •
# -----------------------------------------------------------------------------
def ask_ai(question, context=""):
    if not api_key:
        return "âš ï¸ í˜„ì¬ ì„œë²„ì— API Keyê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Render í™˜ê²½ ë³€ìˆ˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
    
    try:
        llm = ChatGoogleGenerativeAI(model="gemini-1.5-flash", temperature=0.1)
        template = """
        ë„ˆëŠ” ê´‘ìš´ëŒ€í•™êµ í•™ì‚¬ì§€ì›íŒ€ ì†Œì† ì „ë¬¸ ë¹„ì„œì•¼. 
        ì•„ë˜ ì œê³µëœ [í•™êµ ì •ë³´]ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìƒì˜ ì§ˆë¬¸ì— ë‹µë³€í•´ì¤˜.
        ì œê³µë˜ì§€ ì•Šì€ ì •ë³´ì— ëŒ€í•´ì„œëŠ” ì•„ëŠ” ì²™ í•˜ì§€ ë§ê³  ì •ì¤‘íˆ ë‹µë³€í•´.

        [í•™êµ ì •ë³´]
        {context}

        [í•™ìƒ ì§ˆë¬¸]
        {question}
        """
        prompt = PromptTemplate(template=template, input_variables=["context", "question"])
        chain = prompt | llm
        response = chain.invoke({"context": context, "question": question})
        return response.content
    except Exception as e:
        return f"âŒ AI í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"

# -----------------------------------------------------------------------------
# [4] UI ë ˆì´ì•„ì›ƒ
# -----------------------------------------------------------------------------
st.sidebar.title("ğŸ“ KW-ê°•ì˜ë§ˆìŠ¤í„°")
st.sidebar.markdown("ê´‘ìš´ëŒ€ í•™ì—…ì„ ìœ„í•œ ì˜¬ì¸ì› ë¹„ì„œ")
menu = st.sidebar.radio("ê¸°ëŠ¥ ì„ íƒ", ["AI í•™ì‚¬ ìƒë‹´", "ì¡¸ì—…/ì´ìˆ˜ í˜„í™©", "ìŠ¤ë§ˆíŠ¸ ì‹œê°„í‘œ ìƒì„±", "ê°•ì˜ ì¸ì‚¬ì´íŠ¸"])

# === Tab 1: AI í•™ì‚¬ ìƒë‹´ ===
if menu == "AI í•™ì‚¬ ìƒë‹´":
    st.header("ğŸ¤– AI í•™ì‚¬ ì§€ì› ë¹„ì„œ")
    st.info("ê´‘ìš´ëŒ€ í•™ì‚¬ ê·œì •ì§‘ê³¼ ìˆ˜ê°•ì‹ ì²­ ìë£Œë¥¼ ëª¨ë‘ í•™ìŠµí•œ ìƒíƒœì…ë‹ˆë‹¤.")
    
    if "messages" not in st.session_state:
        st.session_state.messages = []

    for msg in st.session_state.messages:
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])

    if prompt := st.chat_input("ì¡¸ì—… ìš”ê±´ì´ë‚˜ ìˆ˜ê°•ì‹ ì²­ì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”."):
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        with st.chat_message("assistant"):
            response = ask_ai(prompt, SCHOOL_RULES)
            st.markdown(response)
        st.session_state.messages.append({"role": "assistant", "content": response})

# === Tab 2: ì¡¸ì—…/ì´ìˆ˜ í˜„í™© ===
elif menu == "ì¡¸ì—…/ì´ìˆ˜ í˜„í™©":
    st.header("ğŸ“Š ì´ìˆ˜ í•™ì  ë¶„ì„")
    col1, col2 = st.columns([1, 1])
    
    with col1:
        st.subheader("ë‚´ í•™ì  ì…ë ¥")
        major_done = st.number_input("ì „ê³µ ì´ìˆ˜ í•™ì ", 0, 130, 45)
        ge_done = st.number_input("êµì–‘ ì´ìˆ˜ í•™ì ", 0, 130, 20)
        etc_done = st.number_input("ì¼ë°˜ ì„ íƒ í•™ì ", 0, 130, 10)
        
    with col2:
        total_done = major_done + ge_done + etc_done
        st.subheader("ë¶„ì„ ê²°ê³¼")
        st.metric("ì´ ì´ìˆ˜ í•™ì ", f"{total_done} / 130")
        
        progress = total_done / 130
        st.progress(progress)
        
        if total_done < 130:
            st.warning(f"ì¡¸ì—…ê¹Œì§€ {130 - total_done}í•™ì  ë” í•„ìš”í•©ë‹ˆë‹¤.")
        else:
            st.success("ì¡¸ì—… ìµœì†Œ í•™ì ì„ ì¶©ì¡±í–ˆìŠµë‹ˆë‹¤!")

    st.divider()
    st.subheader("ì˜ì—­ë³„ í”¼ë“œë°±")
    if major_done < 65:
        st.write("ğŸ“ **ì „ê³µ:** ì „ê³µ í•™ì ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ë‹¤ìŒ í•™ê¸°ì—ëŠ” ì „ê³µ í•„ìˆ˜ ìœ„ì£¼ë¡œ ìˆ˜ê°•í•˜ì„¸ìš”.")
    if ge_done < 35:
        st.write("ğŸ“ **êµì–‘:** êµì–‘ í•™ì ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. í•µì‹¬ êµì–‘ ì˜ì—­ì„ í™•ì¸í•˜ì„¸ìš”.")

# === Tab 3: ìŠ¤ë§ˆíŠ¸ ì‹œê°„í‘œ ìƒì„± ===
elif menu == "ìŠ¤ë§ˆíŠ¸ ì‹œê°„í‘œ ìƒì„±":
    st.header("ğŸ“… ë§ì¶¤í˜• ì‹œê°„í‘œ ì¶”ì²œ")
    st.write("ë‚´ê°€ ì›í•˜ëŠ” ì¡°ê±´ì„ ì„¤ì •í•˜ë©´ AIê°€ ê°•ì˜ë¥¼ ì¡°í•©í•´ë“œë¦½ë‹ˆë‹¤.")
    
    col1, col2 = st.columns(2)
    with col1:
        avoid_day = st.multiselect("í”¼í•˜ê³  ì‹¶ì€ ìš”ì¼", ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ"])
        avoid_morning = st.checkbox("1êµì‹œ(9:00) ìˆ˜ì—… ì œì™¸")
    
    with col2:
        min_courses = st.slider("ìµœì†Œ ìˆ˜ê°• ê³¼ëª© ìˆ˜", 3, 7, 5)
        
    if st.button("ì‹œê°„í‘œ ìë™ ìƒì„±"):
        # í•„í„°ë§ ë¡œì§
        filtered_db = course_db.copy()
        
        # ìš”ì¼ í•„í„°
        for day in avoid_day:
            filtered_db = filtered_db[~filtered_db['ì‹œê°„'].str.contains(day)]
            
        # 1êµì‹œ í•„í„°
        if avoid_morning:
            filtered_db = filtered_db[~filtered_db['ì‹œê°„'].str.contains('1')]
            
        if len(filtered_db) < min_courses:
            st.error("ì¡°ê±´ì— ë§ëŠ” ê°•ì˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. ì¡°ê±´ì„ ì™„í™”í•´ì£¼ì„¸ìš”.")
        else:
            # ëœë¤ ìƒ˜í”Œë§ (ì‹œê°„ ì¤‘ë³µ ì²´í¬ëŠ” ë°ëª¨ìš©ìœ¼ë¡œ ê°„ì†Œí™”)
            recommendation = filtered_db.sample(n=min_courses)
            st.success(f"ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” {min_courses}ê°œ ê³¼ëª©ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!")
            st.table(recommendation[['ê³¼ëª©ëª…', 'êµìˆ˜', 'ì‹œê°„', 'ì˜ì—­']])
            st.info("ğŸ’¡ ìœ„ ì¡°í•©ì€ ì‹œê°„ ì¤‘ë³µ ê°€ëŠ¥ì„±ì„ ê³ ë ¤í•˜ì§€ ì•Šì€ ì¶”ì²œ ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤. (ì •ì‹ ë²„ì „ì—ì„œ ì•Œê³ ë¦¬ì¦˜ ê³ ë„í™” ì˜ˆì •)")

# === Tab 4: ê°•ì˜ ì¸ì‚¬ì´íŠ¸ ===
elif menu == "ê°•ì˜ ì¸ì‚¬ì´íŠ¸":
    st.header("ğŸ’¡ ê°•ì˜ ì •ë°€ ë¶„ì„")
    st.write("ì—ë¸Œë¦¬íƒ€ì„ ë°ì´í„°ì™€ ê°•ì˜ê³„íšì„œë¥¼ ë¶„ì„í•˜ì—¬ ìˆ˜ì—…ì˜ ì„±ê²©ì„ íŒŒì•…í•©ë‹ˆë‹¤.")
    
    selected_c = st.selectbox("ë¶„ì„í•  ê³¼ëª© ì„ íƒ", course_db['ê³¼ëª©ëª…'].tolist())
    c_info = course_db[course_db['ê³¼ëª©ëª…'] == selected_c].iloc[0]
    
    col1, col2, col3 = st.columns(3)
    col1.metric("ì‹œí—˜ ë¹„ì¤‘", f"{c_info['ì‹œí—˜ë¹„ì¤‘']}%")
    col2.metric("ê³¼ì œ ë¹„ì¤‘", f"{c_info['ê³¼ì œë¹„ì¤‘']}%")
    col3.metric("íŒ€í”Œ ìœ ë¬´", c_info['íŒ€í”Œ'])
    
    st.divider()
    st.subheader("AI í•œ ì¤„ í‰")
    if c_info['ì‹œí—˜ë¹„ì¤‘'] >= 70:
        st.write("ğŸ”¥ ì´ ê³¼ëª©ì€ **ì‹œí—˜ í•œ ë°©**ì´ ì¤‘ìš”í•©ë‹ˆë‹¤. í‰ì†Œ ì´ë¡  ë³µìŠµì— ì§‘ì¤‘í•˜ì„¸ìš”.")
    elif c_info['ê³¼ì œë¹„ì¤‘'] >= 40:
        st.write("ğŸ“ **ê³¼ì œí˜• ìˆ˜ì—…**ì…ë‹ˆë‹¤. ê¾¸ì¤€íˆ ê³¼ì œë¥¼ ì œì¶œí•˜ëŠ” ì„±ì‹¤í•¨ì´ í•™ì ì„ ê²°ì •í•©ë‹ˆë‹¤.")
    
    if c_info['íŒ€í”Œ'] == 'ìœ ':
        st.write("ğŸ‘¥ **íŒ€í”Œ ì£¼ì˜!** ì†Œí†µ ëŠ¥ë ¥ì´ ìš”êµ¬ë˜ëŠ” ìˆ˜ì—…ì…ë‹ˆë‹¤.")